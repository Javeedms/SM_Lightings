<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saminoor Lightings Bill Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional appearance and PDF targeting */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Styles specifically for the PDF content container */
        .invoice-document {
            background-color: white;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Hide buttons and interactive elements when printing/generating PDF */
        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Ensure table border collapse for a cleaner look */
        .invoice-table th, .invoice-table td {
            border: 1px solid #e5e7eb;
        }
        /* Custom styling for the multiple advance paid entries */
        .advance-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
    </style>
    <!-- Load html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Control Panel (Non-Printable) -->
        <div class="no-print mb-6 p-4 bg-white rounded-xl shadow-lg border border-indigo-200">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Bill Controls</h2>
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                    <label for="invoice-number-input" class="block text-sm font-medium text-gray-700">Invoice #</label>
                    <input type="text" id="invoice-number-input" value="SML00013" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label for="invoice-date-input" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="invoice-date-input" value="2025-11-23" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <button id="add-item-btn" class="flex items-center justify-center px-4 py-2 mt-5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add Item Row
                </button>
                <button id="download-pdf-btn" class="flex items-center justify-center px-6 py-2 mt-5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download PDF
                </button>
            </div>
        </div>

        <!-- INVOICE DOCUMENT START -->
        <div id="invoice-content" class="invoice-document rounded-xl">

            <!-- Header Section -->
            <header class="flex flex-col sm:flex-row justify-between items-start mb-8 pb-4 border-b border-gray-200">
                <div>
                    <h1 class="text-3xl font-extrabold text-indigo-800">SAMINOOR LIGHTINGS</h1>
                    <!-- Text size reduced to text-xs -->
                    <p class="text-xs text-gray-600 mt-1">Near minar masjid Alampurpeth, Ilkal</p>
                    <p class="text-xs text-gray-600">Phone: +91 9740778757, +91 8453304064</p>
                </div>
                <div class="mt-4 sm:mt-0 bg-indigo-50 px-4 py-2 rounded-lg text-right">
                    <h2 class="text-xl font-bold text-indigo-700">INVOICE</h2>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">Date:</span> <span id="invoice-date-display">2025-11-23</span>
                    </p>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">Invoice #:</span> <span id="invoice-number-display">SML00013</span>
                    </p>
                </div>
            </header>

            <!-- Bill To & Status Section -->
            <div class="flex justify-between mb-8">
                <div class="w-1/2 pr-4">
                    <p class="font-semibold text-gray-700 mb-1">Bill To:</p>
                    <!-- Textarea height and padding reduced, text size set to text-sm -->
                    <textarea id="bill-to-input" class="w-full h-16 p-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Customer Name, Address, Contact details...">Mr. John Doe
123 Main Street
Anytown, 587125</textarea>
                </div>
                <div class="w-1/2 pl-4 text-right">
                    <p class="font-semibold text-gray-700 mb-1">Status:</p>
                    <select id="status-select" class="p-2 border border-gray-300 rounded-md bg-white text-gray-800 font-bold">
                        <option value="Paid" selected class="text-green-600">Paid</option>
                        <option value="Pending" class="text-red-600">Pending</option>
                        <option value="Draft" class="text-yellow-600">Draft</option>
                    </select>
                </div>
            </div>

            <!-- Itemized Details Table -->
            <div class="mb-8 overflow-x-auto">
                <table class="min-w-full invoice-table border-collapse table-auto">
                    <thead>
                        <tr class="bg-indigo-100 text-indigo-800 text-sm leading-normal">
                            <th class="py-2 px-3 text-left w-[15%]">Date</th>
                            <th class="py-2 px-3 text-left w-[40%]">Item</th>
                            <th class="py-2 px-3 text-right w-[10%]">Days</th>
                            <th class="py-2 px-3 text-right w-[15%]">Vehicle Rent (₹)</th>
                            <th class="py-2 px-3 text-right w-[15%]">Amount (₹)</th>
                            <th class="py-2 px-3 text-center w-[5%] no-print"></th>
                        </tr>
                    </thead>
                    <!-- Text size reduced to text-xs -->
                    <tbody id="item-table-body" class="text-gray-700 text-xs font-normal">
                        <!-- Default item row - Initial values set to demonstrate the new sum logic: 10000 + 1200 = 11200 -->
                        <tr class="hover:bg-gray-50 border-b border-gray-200">
                            <td class="py-2 px-3">
                                <input type="date" value="2025-11-20" class="date-input w-full p-1 border-none focus:ring-0">
                            </td>
                            <td class="py-2 px-3">
                                <input type="text" value="LED Light Setup for Stage" class="item-input w-full p-1 border-none focus:ring-0">
                            </td>
                            <!-- Days no longer contributes to line amount but still triggers total calculation -->
                            <td class="py-2 px-3 text-right">
                                <input type="number" value="3" min="1" class="days-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                            </td>
                            <td class="py-2 px-3 text-right">
                                <!-- Vehicle Rent input now contributes to Subtotal -->
                                <input type="number" value="1200" min="0" class="rent-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                            </td>
                            <!-- Amount is the Base Item Cost input and contributes to Subtotal -->
                            <td class="py-2 px-3 text-right font-medium">
                                <input type="number" value="10000.00" min="0" class="amount-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                            </td>
                            <td class="py-2 px-3 text-center no-print">
                                <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg></button>
                            </td>
                        </tr>
                        <!-- Additional items will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Totals and Summary -->
            <div class="flex justify-end">
                <div class="w-full sm:w-1/2 lg:w-1/3 space-y-2 text-sm"> <!-- Totals section font reduced to text-sm -->
                    <div class="flex justify-between border-t pt-2">
                        <span class="text-gray-700 font-medium">Subtotal:</span>
                        <span id="subtotal-display" class="font-bold text-gray-800">₹0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <label for="discount-input" class="text-gray-700 font-medium">Discount (₹):</label>
                        <input type="number" id="discount-input" value="0" min="0" class="w-24 text-right border border-gray-300 rounded-md p-1 focus:outline-none focus:ring-1 focus:ring-indigo-500" oninput="calculateTotals()">
                    </div>
                    
                    <!-- ADVANCE PAID SECTION: Updated to support multiple dated entries -->
                    <div class="pt-2 border-t border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-gray-700 font-medium">Advance Paid Entries:</span>
                            <button id="add-advance-btn" class="text-indigo-600 hover:text-indigo-800 transition duration-150 p-1 rounded-full hover:bg-indigo-100 no-print" title="Add Advance Payment">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        
                        <div id="advance-paid-list" class="space-y-1">
                            <!-- Advance payment entries will be inserted here -->
                            <div class="advance-entry">
                                <input type="date" value="2025-11-23" class="advance-date-input text-xs w-2/5 p-1 border border-gray-300 rounded-md focus:ring-indigo-500">
                                <span class="text-xs">₹</span>
                                <input type="number" value="1000" min="0" class="advance-amount-input text-xs w-2/5 text-right border border-gray-300 rounded-md p-1 focus:ring-indigo-500" oninput="calculateTotals()">
                                <button onclick="removeAdvanceEntry(this)" class="remove-advance-btn text-red-500 hover:text-red-700 p-0.5 no-print" title="Remove Entry">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between font-semibold border-b border-gray-200 py-1">
                        <span class="text-gray-700">Total Advance Paid:</span>
                        <span id="total-advance-display" class="font-bold text-gray-800">₹0.00</span>
                    </div>

                    <div class="flex justify-between border-t border-b-2 border-indigo-500 py-3">
                        <span class="text-xl font-extrabold text-indigo-700">Total Balance:</span>
                        <span id="total-balance-display" class="text-xl font-extrabold text-indigo-700">₹0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer Message -->
            <footer class="mt-12 pt-4 border-t border-gray-200 text-center">
                <p class="text-gray-500 italic">Thank you for choosing Saminoor Lightings!</p>
            </footer>

        </div>
        <!-- INVOICE DOCUMENT END -->

    </div>

    <script>
        const invoiceNumberInput = document.getElementById('invoice-number-input');
        const invoiceDateInput = document.getElementById('invoice-date-input');
        const invoiceNumberDisplay = document.getElementById('invoice-number-display');
        const invoiceDateDisplay = document.getElementById('invoice-date-display');
        const billToInput = document.getElementById('bill-to-input');
        const statusSelect = document.getElementById('status-select');
        const itemTableBody = document.getElementById('item-table-body');
        const addItemBtn = document.getElementById('add-item-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const discountInput = document.getElementById('discount-input');
        const subtotalDisplay = document.getElementById('subtotal-display');
        const totalBalanceDisplay = document.getElementById('total-balance-display');
        
        // New elements for advance payments
        const advancePaidList = document.getElementById('advance-paid-list');
        const addAdvanceBtn = document.getElementById('add-advance-btn');
        const totalAdvanceDisplay = document.getElementById('total-advance-display');


        // --- Utility Functions ---

        // Formats a number to two decimal places with the Indian Rupee symbol
        function formatCurrency(amount) {
            return `₹${parseFloat(amount).toFixed(2)}`;
        }

        // --- Advance Payment Logic ---

        function createAdvancePaymentEntry(amount = 0) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'advance-entry';
            entryDiv.innerHTML = `
                <input type="date" value="${new Date().toISOString().substring(0, 10)}" class="advance-date-input text-xs w-2/5 p-1 border border-gray-300 rounded-md focus:ring-indigo-500">
                <span class="text-xs">₹</span>
                <input type="number" value="${amount}" min="0" class="advance-amount-input text-xs w-2/5 text-right border border-gray-300 rounded-md p-1 focus:ring-indigo-500" oninput="calculateTotals()">
                <button onclick="removeAdvanceEntry(this)" class="remove-advance-btn text-red-500 hover:text-red-700 p-0.5 no-print" title="Remove Entry">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                </button>
            `;
            // Attach input listener to the new row
            entryDiv.querySelector('.advance-amount-input').addEventListener('input', calculateTotals);
            return entryDiv;
        }

        function removeAdvanceEntry(button) {
            button.closest('.advance-entry').remove();
            calculateTotals();
        }
        window.removeAdvanceEntry = removeAdvanceEntry; // Expose to global scope for inline onclick

        // --- Core Logic ---
        
        // Function to create a new, empty item row
        function createItemRow() {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 border-b border-gray-200';
            row.innerHTML = `
                <td class="py-2 px-3">
                    <input type="date" value="${new Date().toISOString().substring(0, 10)}" class="date-input w-full p-1 border-none focus:ring-0">
                </td>
                <td class="py-2 px-3">
                    <input type="text" placeholder="Item/Service description" class="item-input w-full p-1 border-none focus:ring-0">
                </td>
                <!-- Days still triggers total calculation -->
                <td class="py-2 px-3 text-right">
                    <input type="number" value="1" min="1" class="days-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                </td>
                <!-- Rent triggers total calculation -->
                <td class="py-2 px-3 text-right">
                    <input type="number" value="0" min="0" class="rent-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                </td>
                <!-- Amount (Base Cost) triggers total calculation -->
                <td class="py-2 px-3 text-right font-medium">
                    <input type="number" value="100.00" min="0" class="amount-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                </td>
                <td class="py-2 px-3 text-center no-print">
                    <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg></button>
                </td>
            `;
            // Attach input change listeners
            row.querySelector('.days-input').addEventListener('input', calculateTotals);
            row.querySelector('.rent-input').addEventListener('input', calculateTotals);
            row.querySelector('.amount-input').addEventListener('input', calculateTotals);
            
            return row;
        }

        // Function to calculate the totals (Subtotal, Discount, Balance)
        function calculateTotals() {
            let subtotal = 0;
            let totalAdvancePaid = 0;

            // 1. Calculate Subtotal from all line items: Sum of Amount (Base Cost) and Vehicle Rent
            itemTableBody.querySelectorAll('tr').forEach(row => {
                const amountInput = row.querySelector('.amount-input');
                const rentInput = row.querySelector('.rent-input'); 

                // Read the base amount and the rent
                const baseAmount = parseFloat(amountInput.value) || 0;
                const vehicleRent = parseFloat(rentInput.value) || 0; 
                
                // Line Total Contribution = Base Amount + Vehicle Rent (NEW LOGIC)
                const lineTotal = baseAmount + vehicleRent; 
                
                subtotal += lineTotal;
            });
            
            // 2. Calculate Total Advance Paid
            advancePaidList.querySelectorAll('.advance-amount-input').forEach(input => {
                const amount = parseFloat(input.value) || 0;
                totalAdvancePaid += amount;
            });
            
            // 3. Apply discount and advance paid
            const discount = parseFloat(discountInput.value) || 0;

            // 4. Calculate final balance
            let totalBalance = subtotal - discount - totalAdvancePaid;
            totalBalance = Math.max(0, totalBalance); // Ensure balance isn't negative

            // 5. Update the display elements
            subtotalDisplay.textContent = formatCurrency(subtotal);
            totalAdvanceDisplay.textContent = formatCurrency(totalAdvancePaid);
            totalBalanceDisplay.textContent = formatCurrency(totalBalance);
        }

        // Function to remove an item row
        function removeItem(button) {
            if (itemTableBody.children.length > 1) {
                button.closest('tr').remove();
                calculateTotals();
            } else {
                console.log("Cannot remove the last item row.");
            }
        }
        window.removeItem = removeItem; // Expose to global scope for inline onclick

        // Function to handle PDF generation
        function generatePDF() {
            const element = document.getElementById('invoice-content');
            const invoiceNumber = invoiceNumberInput.value.replace(/[^a-zA-Z0-9]/g, '_'); // Sanitize filename
            const filename = `Invoice_${invoiceNumber}.pdf`;

            const opt = {
                margin: 0.5,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            
            // --- 1. Replace Bill To Textarea with Static Div ---
            const billToTextarea = document.getElementById('bill-to-input');
            const billToDiv = document.createElement('div');
            // Use whitespace-pre-wrap to preserve line breaks/formatting
            billToDiv.className = 'whitespace-pre-wrap text-sm h-16 p-1 border border-gray-300 rounded-md'; 
            billToDiv.textContent = billToTextarea.value;
            billToTextarea.replaceWith(billToDiv);

            // --- 2. Temporarily replace the interactive status select with static text ---
            const statusText = statusSelect.options[statusSelect.selectedIndex].text;
            const statusColor = statusSelect.options[statusSelect.selectedIndex].className.split('-')[1]; 
            const statusDiv = document.createElement('div');
            statusDiv.className = `text-lg font-bold text-${statusColor}-600`;
            statusDiv.textContent = `Status: ${statusText}`;
            statusSelect.replaceWith(statusDiv); 
            
            // --- 3. Temporarily replace item inputs with static text for cleaner PDF ---
            const itemInputsToReplace = []; // Array to hold originals and placeholders
            
            itemTableBody.querySelectorAll('tr').forEach(row => {
                const amountInput = row.querySelector('.amount-input');
                const dateInput = row.querySelector('.date-input');
                const itemInput = row.querySelector('.item-input');
                
                // Amount Input (already in previous version, keeping for context)
                const amountSpan = document.createElement('span');
                amountSpan.textContent = formatCurrency(parseFloat(amountInput.value) || 0).replace('₹', ''); 
                itemInputsToReplace.push({ original: amountInput, placeholder: amountSpan, parent: amountInput.parentNode });
                amountInput.replaceWith(amountSpan);
                
                // Date Input (NEW)
                const dateSpan = document.createElement('span');
                dateSpan.textContent = dateInput.value;
                itemInputsToReplace.push({ original: dateInput, placeholder: dateSpan, parent: dateInput.parentNode });
                dateInput.replaceWith(dateSpan);
                
                // Item Description Input (NEW)
                const itemSpan = document.createElement('span');
                itemSpan.textContent = itemInput.value;
                itemInputsToReplace.push({ original: itemInput, placeholder: itemSpan, parent: itemInput.parentNode });
                itemInput.replaceWith(itemSpan);
            });
            
            // --- 4. Temporarily replace advance input fields with static text for cleaner PDF ---
            const advanceEntries = Array.from(advancePaidList.querySelectorAll('.advance-entry'));
            const advancePlaceholders = [];

            advanceEntries.forEach(entry => {
                const date = entry.querySelector('.advance-date-input').value;
                const amount = entry.querySelector('.advance-amount-input').value;
                
                const placeholder = document.createElement('div');
                placeholder.className = 'flex justify-between text-xs text-gray-700'; // text-xs for smaller size
                placeholder.textContent = `${date}: ${formatCurrency(amount)}`;
                
                advancePlaceholders.push({ original: entry, placeholder: placeholder });
                
                // Replace the original, complex entry div with the simple placeholder
                const clonedEntry = entry.cloneNode(true); 
                entry.parentNode.replaceChild(clonedEntry, entry);
                clonedEntry.replaceWith(placeholder);
            });
            

            // Start PDF generation
            html2pdf().set(opt).from(element).save().then(() => {
                // --- 5. Restore Bill To Textarea ---
                billToDiv.replaceWith(billToTextarea);
                
                // --- 6. Restore the original dropdown element ---
                statusDiv.replaceWith(statusSelect);
                
                // --- 7. Restore the original interactive item inputs ---
                itemInputsToReplace.forEach(item => {
                    item.parent.appendChild(item.original);
                    item.placeholder.replaceWith(item.original);
                });
                
                // --- 8. Restore the original interactive advance entries (need to rebuild the list) ---
                advancePaidList.innerHTML = ''; // Clear the list
                advancePlaceholders.forEach(item => {
                    advancePaidList.appendChild(item.original);
                });
            });
        }

        // --- Event Listeners and Initialization ---

        // Initialize today's date
        invoiceDateInput.value = new Date().toISOString().substring(0, 10);

        // Link control inputs to display areas
        invoiceNumberInput.addEventListener('input', () => invoiceNumberDisplay.textContent = invoiceNumberInput.value);
        invoiceDateInput.addEventListener('change', () => invoiceDateDisplay.textContent = invoiceDateInput.value);

        // Add item button handler
        addItemBtn.addEventListener('click', () => {
            itemTableBody.appendChild(createItemRow());
            calculateTotals(); // Must calculate totals to include the new row's default amount
        });

        // Add advance payment button handler
        addAdvanceBtn.addEventListener('click', () => {
            advancePaidList.appendChild(createAdvancePaymentEntry());
            calculateTotals();
        });

        // PDF Download handler
        downloadPdfBtn.addEventListener('click', generatePDF);

        // Calculate initial totals on load
        document.addEventListener('DOMContentLoaded', calculateTotals);

    </script>
</body>
</html>