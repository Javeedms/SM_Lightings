<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saminoor Lightings Bill Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .invoice-document {
            background-color: white;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }

        .invoice-table th, .invoice-table td {
            border: 1px solid #e5e7eb;
        }
        
        .advance-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        /* Helper to hide inputs but show their values during PDF generation */
        .pdf-text-only {
            border: none !important;
            background: transparent !important;
            padding: 0 !important;
            appearance: none;
            -webkit-appearance: none;
        }
    </style>
    <!-- Load html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Control Panel (Non-Printable) -->
        <div class="no-print mb-6 p-4 bg-white rounded-xl shadow-lg border border-indigo-200">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Bill Controls</h2>
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                    <label for="invoice-number-input" class="block text-sm font-medium text-gray-700">Invoice #</label>
                    <input type="text" id="invoice-number-input" value="SML00013" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label for="invoice-date-input" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="invoice-date-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <button id="add-item-btn" class="flex items-center justify-center px-4 py-2 mt-5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add Item Row
                </button>
                <button id="download-pdf-btn" class="flex items-center justify-center px-6 py-2 mt-5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download PDF
                </button>
            </div>
        </div>

        <!-- INVOICE DOCUMENT START -->
        <div id="invoice-content" class="invoice-document rounded-xl">

            <!-- Header Section -->
            <header class="flex flex-col sm:flex-row justify-between items-start mb-8 pb-4 border-b border-gray-200">
                <div>
                    <h1 class="text-3xl font-extrabold text-indigo-800">SAMINOOR LIGHTINGS</h1>
                    <p class="text-sm text-gray-600 mt-1">Near minar masjid Alampurpeth, Ilkal</p>
                    <p class="text-sm text-gray-600">Phone: +91 9740778757, +91 8453304064</p>
                </div>
                <div class="mt-4 sm:mt-0 bg-indigo-50 px-4 py-2 rounded-lg text-right">
                    <h2 class="text-xl font-bold text-indigo-700">INVOICE</h2>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">Date:</span> <span id="invoice-date-display"></span>
                    </p>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">Invoice #:</span> <span id="invoice-number-display">SML00013</span>
                    </p>
                </div>
            </header>

            <!-- Bill To & Status Section -->
            <div class="flex justify-between mb-8">
                <div class="w-1/2 pr-4">
                    <p class="font-semibold text-gray-700 mb-1">Bill To:</p>
                    <textarea id="bill-to-input" class="w-full h-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Customer Name, Address, Contact details...">Mr. John Doe&#10;123 Main Street&#10;Anytown, 587125</textarea>
                </div>
                <div class="w-1/2 pl-4 text-right">
                    <p class="font-semibold text-gray-700 mb-1">Status:</p>
                    <select id="status-select" class="p-2 border border-gray-300 rounded-md bg-white text-gray-800 font-bold">
                        <option value="Paid" selected class="text-green-600">Paid</option>
                        <option value="Pending" class="text-red-600">Pending</option>
                        <option value="Draft" class="text-yellow-600">Draft</option>
                    </select>
                </div>
            </div>

            <!-- Itemized Details Table -->
            <div class="mb-8 overflow-x-auto">
                <table class="min-w-full invoice-table border-collapse table-auto">
                    <thead>
                        <tr class="bg-indigo-100 text-indigo-800 text-sm leading-normal">
                            <th class="py-2 px-3 text-left w-[15%]">Date</th>
                            <th class="py-2 px-3 text-left w-[40%]">Item</th>
                            <th class="py-2 px-3 text-right w-[10%]">Days</th>
                            <th class="py-2 px-3 text-right w-[15%]">Vehicle Rent (₹)</th>
                            <th class="py-2 px-3 text-right w-[15%]">Amount (₹)</th>
                            <th class="py-2 px-3 text-center w-[5%] no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="item-table-body" class="text-gray-700 text-sm font-light">
                        <tr class="hover:bg-gray-50 border-b border-gray-200">
                            <td class="py-2 px-3">
                                <input type="date" value="2025-11-20" class="date-input w-full p-1 border-none focus:ring-0">
                            </td>
                            <td class="py-2 px-3">
                                <input type="text" value="LED Light Setup for Stage" class="item-input w-full p-1 border-none focus:ring-0">
                            </td>
                            <td class="py-2 px-3 text-right">
                                <input type="number" value="3" min="1" class="days-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                            </td>
                            <td class="py-2 px-3 text-right">
                                <input type="number" value="1200" min="0" class="rent-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                            </td>
                            <td class="py-2 px-3 text-right font-medium">
                                <input type="number" value="10000.00" min="0" class="amount-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                            </td>
                            <td class="py-2 px-3 text-center no-print">
                                <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Totals and Summary -->
            <div class="flex justify-end">
                <div class="w-full sm:w-1/2 lg:w-1/3 space-y-2">
                    <div class="flex justify-between border-t pt-2">
                        <span class="text-gray-700 font-medium">Subtotal:</span>
                        <span id="subtotal-display" class="font-bold text-gray-800">₹0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <label for="discount-input" class="text-gray-700 font-medium">Discount (₹):</label>
                        <input type="number" id="discount-input" value="0" min="0" class="w-24 text-right border border-gray-300 rounded-md p-1 focus:outline-none focus:ring-1 focus:ring-indigo-500" oninput="calculateTotals()">
                    </div>
                    
                    <div class="pt-2 border-t border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-gray-700 font-medium">Advance Paid Entries:</span>
                            <button id="add-advance-btn" class="text-indigo-600 hover:text-indigo-800 transition duration-150 p-1 rounded-full hover:bg-indigo-100 no-print" title="Add Advance Payment">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        
                        <div id="advance-paid-list" class="space-y-1">
                            <div class="advance-entry">
                                <input type="date" value="2025-11-23" class="advance-date-input text-xs w-2/5 p-1 border border-gray-300 rounded-md focus:ring-indigo-500">
                                <span class="text-xs">₹</span>
                                <input type="number" value="1000" min="0" class="advance-amount-input text-xs w-2/5 text-right border border-gray-300 rounded-md p-1 focus:ring-indigo-500" oninput="calculateTotals()">
                                <button onclick="removeAdvanceEntry(this)" class="remove-advance-btn text-red-500 hover:text-red-700 p-0.5 no-print" title="Remove Entry">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between font-semibold border-b border-gray-200 py-1">
                        <span class="text-gray-700">Total Advance Paid:</span>
                        <span id="total-advance-display" class="font-bold text-gray-800">₹0.00</span>
                    </div>

                    <div class="flex justify-between border-t border-b-2 border-indigo-500 py-3">
                        <span class="text-xl font-extrabold text-indigo-700">Total Balance:</span>
                        <span id="total-balance-display" class="text-xl font-extrabold text-indigo-700">₹0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer Message -->
            <footer class="mt-12 pt-4 border-t border-gray-200 text-center">
                <p class="text-gray-500 italic">Thank you for choosing Saminoor Lightings!</p>
            </footer>

        </div>
    </div>

    <script>
        const invoiceNumberInput = document.getElementById('invoice-number-input');
        const invoiceDateInput = document.getElementById('invoice-date-input');
        const invoiceNumberDisplay = document.getElementById('invoice-number-display');
        const invoiceDateDisplay = document.getElementById('invoice-date-display');
        const billToInput = document.getElementById('bill-to-input');
        const statusSelect = document.getElementById('status-select');
        const itemTableBody = document.getElementById('item-table-body');
        const addItemBtn = document.getElementById('add-item-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const discountInput = document.getElementById('discount-input');
        const subtotalDisplay = document.getElementById('subtotal-display');
        const totalBalanceDisplay = document.getElementById('total-balance-display');
        const advancePaidList = document.getElementById('advance-paid-list');
        const addAdvanceBtn = document.getElementById('add-advance-btn');
        const totalAdvanceDisplay = document.getElementById('total-advance-display');

        function formatCurrency(amount) {
            return `₹${parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function createAdvancePaymentEntry(amount = 0) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'advance-entry';
            entryDiv.innerHTML = `
                <input type="date" value="${new Date().toISOString().substring(0, 10)}" class="advance-date-input text-xs w-2/5 p-1 border border-gray-300 rounded-md focus:ring-indigo-500">
                <span class="text-xs">₹</span>
                <input type="number" value="${amount}" min="0" class="advance-amount-input text-xs w-2/5 text-right border border-gray-300 rounded-md p-1 focus:ring-indigo-500" oninput="calculateTotals()">
                <button onclick="removeAdvanceEntry(this)" class="remove-advance-btn text-red-500 hover:text-red-700 p-0.5 no-print" title="Remove Entry">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                </button>
            `;
            return entryDiv;
        }

        function removeAdvanceEntry(button) {
            button.closest('.advance-entry').remove();
            calculateTotals();
        }
        window.removeAdvanceEntry = removeAdvanceEntry;

        function createItemRow() {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 border-b border-gray-200';
            row.innerHTML = `
                <td class="py-2 px-3">
                    <input type="date" value="${new Date().toISOString().substring(0, 10)}" class="date-input w-full p-1 border-none focus:ring-0">
                </td>
                <td class="py-2 px-3">
                    <input type="text" placeholder="Item/Service description" class="item-input w-full p-1 border-none focus:ring-0">
                </td>
                <td class="py-2 px-3 text-right">
                    <input type="number" value="1" min="1" class="days-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                </td>
                <td class="py-2 px-3 text-right">
                    <input type="number" value="0" min="0" class="rent-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                </td>
                <td class="py-2 px-3 text-right font-medium">
                    <input type="number" value="0.00" min="0" class="amount-input w-full text-right p-1 border-none focus:ring-0" oninput="calculateTotals()">
                </td>
                <td class="py-2 px-3 text-center no-print">
                    <button onclick="removeItem(this)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg></button>
                </td>
            `;
            return row;
        }

        function calculateTotals() {
            let subtotal = 0;
            let totalAdvancePaid = 0;

            itemTableBody.querySelectorAll('tr').forEach(row => {
                const amount = parseFloat(row.querySelector('.amount-input').value) || 0;
                const rent = parseFloat(row.querySelector('.rent-input').value) || 0; 
                subtotal += (amount + rent);
            });
            
            advancePaidList.querySelectorAll('.advance-amount-input').forEach(input => {
                totalAdvancePaid += (parseFloat(input.value) || 0);
            });
            
            const discount = parseFloat(discountInput.value) || 0;
            let totalBalance = subtotal - discount - totalAdvancePaid;

            subtotalDisplay.textContent = formatCurrency(subtotal);
            totalAdvanceDisplay.textContent = formatCurrency(totalAdvancePaid);
            totalBalanceDisplay.textContent = formatCurrency(Math.max(0, totalBalance));
        }

        function removeItem(button) {
            if (itemTableBody.children.length > 1) {
                button.closest('tr').remove();
                calculateTotals();
            }
        }
        window.removeItem = removeItem;

        // Function to replace inputs with static spans for PDF
        function prepareForPDF() {
            const replacements = [];

            // Replace Bill To Textarea
            const billToVal = billToInput.value;
            const billToSpan = document.createElement('div');
            billToSpan.className = "whitespace-pre-wrap text-sm text-gray-700 min-h-[6rem]";
            billToSpan.textContent = billToVal;
            replacements.push({ el: billToInput, placeholder: billToSpan });

            // Replace Status Select
            const statusText = statusSelect.options[statusSelect.selectedIndex].text;
            const statusColor = statusSelect.options[statusSelect.selectedIndex].className.split('-')[1] || 'gray';
            const statusDiv = document.createElement('div');
            statusDiv.className = `text-lg font-bold text-${statusColor}-600`;
            statusDiv.textContent = `Status: ${statusText}`;
            replacements.push({ el: statusSelect, placeholder: statusDiv });

            // Replace all Table Inputs
            itemTableBody.querySelectorAll('input').forEach(input => {
                const span = document.createElement('span');
                span.className = "text-sm text-gray-700 block w-full";
                
                if (input.type === 'number') {
                    span.textContent = parseFloat(input.value || 0).toFixed(2);
                    span.className += " text-right";
                } else {
                    span.textContent = input.value;
                }
                replacements.push({ el: input, placeholder: span });
            });

            // Replace Advance Entry Inputs
            advancePaidList.querySelectorAll('.advance-entry').forEach(entry => {
                const date = entry.querySelector('.advance-date-input').value;
                const amount = entry.querySelector('.advance-amount-input').value;
                const div = document.createElement('div');
                div.className = "flex justify-between text-xs text-gray-700 py-0.5 border-b border-gray-100 last:border-0";
                div.innerHTML = `<span>${date}</span><span>${formatCurrency(amount)}</span>`;
                replacements.push({ el: entry, placeholder: div });
            });

            // Execute replacements
            replacements.forEach(item => item.el.replaceWith(item.placeholder));
            return replacements;
        }

        function restoreFromPDF(replacements) {
            // Restore in reverse to avoid DOM nesting issues
            replacements.reverse().forEach(item => item.placeholder.replaceWith(item.el));
        }

        async function generatePDF() {
            const element = document.getElementById('invoice-content');
            const invoiceNumber = invoiceNumberInput.value.replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `Invoice_${invoiceNumber}.pdf`;

            // Prepare UI for static rendering
            const replacements = prepareForPDF();

            const opt = {
                margin: 0.5,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            try {
                await html2pdf().set(opt).from(element).save();
            } finally {
                // Restore interactive elements
                restoreFromPDF(replacements);
            }
        }

        // --- Event Listeners and Initialization ---

        // Initialize date
        const today = new Date().toISOString().substring(0, 10);
        invoiceDateInput.value = today;
        invoiceDateDisplay.textContent = today; // Sync on load

        // Critical: Sync input to display area whenever user changes the date
        invoiceDateInput.addEventListener('change', (e) => {
            invoiceDateDisplay.textContent = e.target.value;
        });

        invoiceNumberInput.addEventListener('input', () => {
            invoiceNumberDisplay.textContent = invoiceNumberInput.value;
        });

        addItemBtn.addEventListener('click', () => {
            itemTableBody.appendChild(createItemRow());
            calculateTotals();
        });

        addAdvanceBtn.addEventListener('click', () => {
            advancePaidList.appendChild(createAdvancePaymentEntry());
            calculateTotals();
        });

        downloadPdfBtn.addEventListener('click', generatePDF);

        document.addEventListener('DOMContentLoaded', calculateTotals);
    </script>
</body>
</html>
